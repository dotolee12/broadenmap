<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ëŒ€ë™ì—¬ì§€ë„ - í†µí•© ë²„ì „</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            overflow: hidden;
        }

        .version-selector {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .selector-content {
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selector-title {
            font-size: 32px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .selector-subtitle {
            font-size: 16px;
            margin-bottom: 40px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .version-options {
            display: flex;
            gap: 30px;
            justify-content: center;
        }

        .version-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            width: 250px;
        }

        .version-card:hover {
            transform: translateY(-5px);
            border-color: #4ecdc4;
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
        }

        .version-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .version-card p {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .version-card .features {
            margin-top: 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .main {
            flex: 1;
            position: relative;
        }

        h1 {
            color: #4ecdc4;
            margin-bottom: 20px;
            text-align: center;
            font-size: 22px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            margin-bottom: 12px;
            color: #4ecdc4;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            margin: 5px;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #5a67d8, #6c5ce7);
        }

        button.active {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .time-display {
            font-weight: bold;
            text-align: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 16px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .instruction {
            background: rgba(76, 175, 80, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            border-left: 4px solid #4caf50;
            line-height: 1.4;
        }

        .legend {
            background: rgba(255, 255, 255, 0.08);
            padding: 12px;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            line-height: 1.3;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 10px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        #map, #canvas {
            height: 100vh;
            width: 100%;
        }

        #canvas {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            cursor: crosshair;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .stats span {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            color: #4ecdc4;
            z-index: 2000;
        }

        .version-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1500;
        }

        .version-switch button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            margin: 0 2px;
            font-size: 12px;
        }

        .current-mode {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1500;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 45vh;
                overflow-y: scroll;
            }
            
            .main {
                height: 55vh;
            }
            
            #map, #canvas {
                height: 55vh;
            }

            .version-options {
                flex-direction: column;
                gap: 20px;
            }

            .version-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- ë²„ì „ ì„ íƒ í™”ë©´ -->
    <div class="version-selector" id="versionSelector">
        <div class="selector-content">
            <h1 class="selector-title">ğŸ—ºï¸ ë‚˜ì˜ ëŒ€ë™ì—¬ì§€ë„</h1>
            <p class="selector-subtitle">
                ê¹€ì •í˜¸ì˜ ëŒ€ë™ì—¬ì§€ë„ì—ì„œ ì˜ê°ì„ ë°›ì€<br>
                ê°œì¸ ì´ë™ ê²½ë¡œ ì‹œê°í™” ì‹œìŠ¤í…œ
            </p>
            
            <div class="version-options">
                <div class="version-card" onclick="selectVersion('map')">
                    <h3>ğŸŒ ì‹¤ì œ ì§€ë„ ë²„ì „</h3>
                    <p>OpenStreetMapì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹¤ì œ GPS ìœ„ì¹˜ ì¶”ì </p>
                    <div class="features">
                        âœ… ì‹¤ì œ ì§€ë„ ìœ„ ì‹œê°í™”<br>
                        âœ… GPS ì¢Œí‘œ ì •í™•ì„±<br>
                        âœ… ì¤Œ/íŒ¬ ê¸°ëŠ¥<br>
                        âœ… í˜„ì¬ ìœ„ì¹˜ ì§€ì›<br>
                        âš ï¸ ì¸í„°ë„· ì—°ê²° í•„ìš”
                    </div>
                </div>
                
                <div class="version-card" onclick="selectVersion('canvas')">
                    <h3>ğŸ¨ Canvas ë²„ì „</h3>
                    <p>ìˆœìˆ˜ Canvas ê¸°ë°˜ì˜ ë¹ ë¥¸ í”„ë¡œí† íƒ€ì…</p>
                    <div class="features">
                        âœ… ë¹ ë¥¸ ë¡œë”©<br>
                        âœ… ì˜¤í”„ë¼ì¸ ì‘ë™<br>
                        âœ… ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜<br>
                        âœ… ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ<br>
                        â„¹ï¸ í…ŒìŠ¤íŠ¸/ë°ëª¨ìš©
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="container" id="mainApp" style="display: none;">
        <div class="sidebar">
            <h1>ğŸ—ºï¸ ë‚˜ì˜ ëŒ€ë™ì—¬ì§€ë„</h1>
            <div style="text-align: center; font-size: 12px; color: #4ecdc4; margin-bottom: 15px;" id="currentMode">
                <!-- í˜„ì¬ ëª¨ë“œ í‘œì‹œ -->
            </div>
            
            <div class="instruction" id="instructionText">
                <!-- ëª¨ë“œë³„ ì„¤ëª… -->
            </div>
            
            <!-- ì§€ë„ ë²„ì „ ì „ìš© ì»¨íŠ¸ë¡¤ -->
            <div class="section" id="mapControls" style="display: none;">
                <h3>ğŸ“ ìœ„ì¹˜ ì œì–´</h3>
                <div class="button-group">
                    <button onclick="getCurrentLocation()">í˜„ì¬ ìœ„ì¹˜</button>
                    <button onclick="goToSeoul()">ì„œìš¸ì‹œì²­</button>
                    <button onclick="goToGangnam()">ê°•ë‚¨ì—­</button>
                </div>
            </div>
            
            <div class="section">
                <h3>â±ï¸ ì‹œë®¬ë ˆì´ì…˜ ì œì–´</h3>
                <div class="button-group">
                    <button onclick="toggleSimulation()" id="simBtn">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
                    <button onclick="addRandomRoute()">ëœë¤ ê²½ë¡œ ì¶”ê°€</button>
                    <button onclick="clearAll()">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
                </div>
                
                <div style="margin-top: 10px;">
                    <strong>ì‹œê°„ ê°€ì†:</strong>
                    <div class="button-group" style="margin-top: 5px;">
                        <button onclick="setSpeed(1)" class="speed active">1x</button>
                        <button onclick="setSpeed(60)" class="speed">60x</button>
                        <button onclick="setSpeed(600)" class="speed">600x</button>
                        <button onclick="setSpeed(3600)" class="speed">3600x</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
                <div class="time-display" id="timeDisplay">2024-01-01 12:00:00</div>
                <div class="stats">
                    <span>ê°€ì†: <span id="speedText">1x</span></span>
                    <span>ìƒíƒœ: <span id="status">ì •ì§€</span></span>
                </div>
                <div class="stats">
                    <span id="routeCount">ê²½ë¡œ: 0ê°œ</span>
                    <span id="stayCount">ì²´ë¥˜: 0ê³³</span>
                </div>
                <div class="stats" id="locationStats" style="display: none;">
                    <span id="currentLocation">ìœ„ì¹˜: ì¤€ë¹„ì¤‘</span>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ¨ 5ë‹¨ê³„ ê¸°ì–µ ì‹œìŠ¤í…œ</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFFFFF; border: 1px solid #666;"></div>
                        <span>1ë‹¨ê³„: í°ìƒ‰ (100%â†’40%, 10ì‹œê°„)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #90EE90;"></div>
                        <span>â†’ ì—°ë‘ìƒ‰ (40%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #32CD32;"></div>
                        <span>2ë‹¨ê³„: ì´ˆë¡ìƒ‰ (40%, 14ì‹œê°„)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFA500;"></div>
                        <span>3ë‹¨ê³„: ì£¼í™©ìƒ‰ (40%, 7ì¼)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF0000;"></div>
                        <span>4ë‹¨ê³„: ë¹¨ê°„ìƒ‰ (40%, 100ì¼)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8B4513;"></div>
                        <span>5ë‹¨ê³„: ê°ˆìƒ‰ (40%, ì˜êµ¬)</span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 10px;" id="stayInfo">
                        <strong>ğŸ”µ ì²´ë¥˜ ì§€ì :</strong> 30ë¶„=25m â†’ 120ë¶„=100m ë°˜ê²½
                    </div>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="loading" id="loading" style="display: none;">
                ğŸ—ºï¸ ì§€ë„ ë¡œë”© ì¤‘...
            </div>

            <div class="current-mode" id="modeIndicator"></div>

            <div class="version-switch">
                <button onclick="switchVersion()">ë‹¤ë¥¸ ë²„ì „</button>
                <button onclick="showVersionSelector()">ë²„ì „ ì„ íƒ</button>
            </div>

            <div id="map" style="display: none;"></div>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentVersion = null;
        let map = null;
        let canvas = null;
        let ctx = null;
        let routes = [];
        let stayPoints = [];
        let running = false;
        let currentTime = new Date('2024-01-01T12:00:00');
        let speed = 1;
        let interval;
        let clickPoint = null;
        let lastClickTime = null;
        let mapReady = false;

        // ë²„ì „ ì„ íƒ
        function selectVersion(version) {
            currentVersion = version;
            document.getElementById('versionSelector').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            if (version === 'map') {
                initMapVersion();
            } else {
                initCanvasVersion();
            }
        }

        // ì§€ë„ ë²„ì „ ì´ˆê¸°í™”
        function initMapVersion() {
            document.getElementById('currentMode').textContent = 'ì‹¤ì œ ì§€ë„ ë²„ì „';
            document.getElementById('modeIndicator').textContent = 'ğŸŒ ì§€ë„ ëª¨ë“œ';
            document.getElementById('mapControls').style.display = 'block';
            document.getElementById('locationStats').style.display = 'flex';
            document.getElementById('instructionText').innerHTML = `
                ğŸŒ <strong>ì‹¤ì œ ì§€ë„ ê¸°ë°˜</strong><br>
                OpenStreetMapì„ ì‚¬ìš©í•œ ì‹¤ì œ ìœ„ì¹˜ ì¶”ì  ì‹œìŠ¤í…œì…ë‹ˆë‹¤.<br><br>
                ğŸ“ <strong>ì‚¬ìš©ë²•:</strong><br>
                â€¢ <strong>ì²« í´ë¦­:</strong> ì‹¤ì œ ìœ„ì¹˜ì—ì„œ ë¨¸ë¬´ë¥´ê¸° ì‹œì‘<br>
                â€¢ <strong>ë‘ ë²ˆì§¸ í´ë¦­:</strong> ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™<br>
                â€¢ <strong>ì²´ë¥˜ ì§€ì :</strong> 30ë¶„+ ë¨¸ë¬´ë¥´ë©´ ì›í˜•ìœ¼ë¡œ í‘œì‹œ<br>
                â€¢ <strong>ì¤Œ/íŒ¬:</strong> ì§€ë„ í™•ëŒ€/ì¶•ì†Œ ë° ì´ë™ ê°€ëŠ¥
            `;
            document.getElementById('stayInfo').innerHTML = '<strong>ğŸ”µ ì²´ë¥˜ ì§€ì :</strong> 30ë¶„=25m â†’ 120ë¶„=100m ë°˜ê²½';
            
            document.getElementById('map').style.display = 'block';
            document.getElementById('canvas').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            initMap();
        }

        // Canvas ë²„ì „ ì´ˆê¸°í™”
        function initCanvasVersion() {
            document.getElementById('currentMode').textContent = 'Canvas ë²„ì „';
            document.getElementById('modeIndicator').textContent = 'ğŸ¨ Canvas ëª¨ë“œ';
            document.getElementById('mapControls').style.display = 'none';
            document.getElementById('locationStats').style.display = 'none';
            document.getElementById('instructionText').innerHTML = `
                ğŸ¨ <strong>Canvas ê¸°ë°˜ í”„ë¡œí† íƒ€ì…</strong><br>
                ë¹ ë¥¸ ë Œë”ë§ê³¼ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.<br><br>
                ğŸ“ <strong>ì‚¬ìš©ë²•:</strong><br>
                â€¢ <strong>ì²« í´ë¦­:</strong> ë¨¸ë¬´ë¥´ê¸° ì‹œì‘ (ì²´ë¥˜ì‹œê°„ ëˆ„ì )<br>
                â€¢ <strong>ë‘ ë²ˆì§¸ í´ë¦­:</strong> ì´ë™ ì™„ë£Œ (ê²½ë¡œ ìƒì„±)<br>
                â€¢ <strong>ì²´ë¥˜ ì§€ì :</strong> 30ë¶„+ ë¨¸ë¬´ë¥´ë©´ ì›í˜•ìœ¼ë¡œ í‘œì‹œ<br>
                â€¢ <strong>ê²©ì ë°°ê²½:</strong> ì¢Œí‘œ ì°¸ì¡°ìš©
            `;
            document.getElementById('stayInfo').innerHTML = '<strong>ğŸ”µ ì²´ë¥˜ ì§€ì :</strong> 30ë¶„=2.5m â†’ 120ë¶„=10m ë°˜ê²½';
            
            document.getElementById('map').style.display = 'none';
            document.getElementById('canvas').style.display = 'block';
            
            initCanvas();
        }

        // ì§€ë„ ì´ˆê¸°í™” (Leaflet)
        function initMap() {
            try {
                console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘...');
                
                map = L.map('map').setView([37.5665, 126.9780], 16);
                
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19
                });
                
                tileLayer.addTo(map);
                
                map.on('click', function(e) {
                    if (mapReady) {
                        handleMapClick(e.latlng);
                    }
                });
                
                map.whenReady(function() {
                    console.log('ì§€ë„ ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ');
                    mapReady = true;
                    document.getElementById('loading').style.display = 'none';
                    updateCurrentLocation();
                    
                    setTimeout(() => {
                        addRandomRoute();
                        addRandomRoute();
                        addRandomRoute();
                    }, 1000);
                });
                
                map.on('moveend', updateCurrentLocation);
                
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('loading').innerHTML = 'âŒ ì§€ë„ ë¡œë”© ì‹¤íŒ¨';
            }
        }

        // Canvas ì´ˆê¸°í™”
        function initCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                handleCanvasClick({x, y});
            });
            
            // ì´ˆê¸° í…ŒìŠ¤íŠ¸ ë°ì´í„°
            setTimeout(() => {
                addRandomRoute();
                addRandomRoute();
                addRandomRoute();
            }, 500);
        }

        // Canvas í¬ê¸° ì¡°ì •
        function resizeCanvas() {
            if (canvas) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                if (currentVersion === 'canvas') {
                    drawCanvas();
                }
            }
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ë“¤
        function getStayRadius(stayMinutes) {
            if (stayMinutes < 30) return 0;
            
            if (currentVersion === 'map') {
                const baseRadius = 25; // 25m
                const maxRadius = 100; // 100m
                const minStay = 30;
                const maxStay = 120;
                
                if (stayMinutes >= maxStay) return maxRadius;
                const progress = (stayMinutes - minStay) / (maxStay - minStay);
                return baseRadius + (maxRadius - baseRadius) * progress;
            } else {
                const baseRadius = 2.5;
                const maxRadius = 10;
                const minStay = 30;
                const maxStay = 120;
                
                if (stayMinutes >= maxStay) return maxRadius;
                const progress = (stayMinutes - minStay) / (maxStay - minStay);
                return baseRadius + (maxRadius - baseRadius) * progress;
            }
        }

        function getDistance(p1, p2) {
            if (currentVersion === 'map') {
                return map.distance(p1, p2);
            } else {
                const dx = p1.x - p2.x;
                const dy = p1.y - p2.y;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // ê²½ë¡œ ìƒíƒœ ê³„ì‚°
        function getRouteState(ageInMinutes) {
            if (ageInMinutes < 600) {
                const opacity = Math.max(0.4, 1.0 - (ageInMinutes / 600) * 0.6);
                if (opacity <= 0.4) {
                    return { color: '#90EE90', opacity: 0.4 };
                }
                return { color: '#FFFFFF', opacity: opacity };
            } else if (ageInMinutes < 1440) {
                return { color: '#32CD32', opacity: 0.4 };
            } else if (ageInMinutes < 10080) {
                return { color: '#FFA500', opacity: 0.4 };
            } else if (ageInMinutes < 144000) {
                return { color: '#FF0000', opacity: 0.4 };
            } else {
                return { color: '#8B4513', opacity: 0.4 };
            }
        }

        // ì²´ë¥˜ ì§€ì  ì—…ë°ì´íŠ¸
        function updateStayPoint(point, currentTime, isStaying = true) {
            const threshold = currentVersion === 'map' ? 50 : 20;
            
            for (let stay of stayPoints) {
                const stayPoint = currentVersion === 'map' ? stay.latlng : stay;
                if (getDistance(point, stayPoint) < threshold) {
                    if (isStaying) {
                        stay.endTime = new Date(currentTime);
                        const duration = ((stay.endTime - stay.startTime) / 60000).toFixed(1);
                        console.log(`ê¸°ì¡´ ì²´ë¥˜ì§€ì  ì—°ì¥: ${duration}ë¶„`);
                        
                        if (currentVersion === 'map' && stay.circle) {
                            const newRadius = getStayRadius(duration);
                            stay.circle.setRadius(newRadius);
                        }
                    }
                    return stay;
                }
            }
            
            if (isStaying) {
                const newStay = {
                    [currentVersion === 'map' ? 'latlng' : 'x']: currentVersion === 'map' ? point : point.x,
                    [currentVersion === 'map' ? 'y' : 'y']: currentVersion === 'map' ? undefined : point.y,
                    startTime: new Date(currentTime),
                    endTime: new Date(currentTime),
                    created: new Date(currentTime),
                    circle: null,
                    marker: null
                };
                stayPoints.push(newStay);
                console.log('ìƒˆë¡œìš´ ì²´ë¥˜ì§€ì  ìƒì„±');
                return newStay;
            }
            
            return null;
        }

        // ì§€ë„ í´ë¦­ ì²˜ë¦¬
        function handleMapClick(latlng) {
            if (!clickPoint) {
                clickPoint = {
                    latlng: latlng,
                    marker: L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'start-marker',
                            html: '<div style="background: #ff6b6b; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map)
                };
                lastClickTime = new Date(currentTime);
                console.log('ì‹œì‘ì  ì„¤ì • (ë¨¸ë¬´ë¥´ê¸° ì‹œì‘)');
                updateStayPoint(latlng, currentTime, true);
            } else {
                const stayDuration = (currentTime - lastClickTime) / (1000 * 60);
                console.log(`ì´ì „ ì§€ì  ì²´ë¥˜ ì™„ë£Œ: ${stayDuration.toFixed(1)}ë¶„`);
                
                const route = {
                    start: clickPoint.latlng,
                    end: latlng,
                    created: new Date(currentTime),
                    polyline: null
                };
                
                route.polyline = L.polyline([clickPoint.latlng, latlng], {
                    color: '#FFFFFF',
                    weight: 4,
                    opacity: 1.0
                }).addTo(map);
                
                routes.push(route);
                
                if (clickPoint.marker) {
                    map.removeLayer(clickPoint.marker);
                }
                
                updateStayPoint(latlng, currentTime, false);
                
                clickPoint = null;
                lastClickTime = null;
                console.log('ê²½ë¡œ ìƒì„± ì™„ë£Œ (ì´ë™í•¨)');
                updateCount();
            }
        }

        // Canvas í´ë¦­ ì²˜ë¦¬
        function handleCanvasClick(point) {
            if (!clickPoint) {
                clickPoint = point;
                lastClickTime = new Date(currentTime);
                console.log('ì‹œì‘ì  ì„¤ì • (ë¨¸ë¬´ë¥´ê¸° ì‹œì‘)');
                updateStayPoint(point, currentTime, true);
            } else {
                const stayDuration = (currentTime - lastClickTime) / (1000 * 60);
                console.log(`ì´ì „ ì§€ì  ì²´ë¥˜ ì™„ë£Œ: ${stayDuration.toFixed(1)}ë¶„`);
                
                const route = {
                    start: clickPoint,
                    end: point,
                    created: new Date(currentTime)
                };
                routes.push(route);
                
                updateStayPoint(point, currentTime, false);
                
                <!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ëŒ€ë™ì—¬ì§€ë„ - í†µí•© ë²„ì „
